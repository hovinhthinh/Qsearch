<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>TabQs</title>
    <link href="../fontawesome_5.10.1/css/all.css" rel="stylesheet" crossorigin="anonymous">
    <link href="../css/bootstrap_4.0.0.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="../css/local.css" rel="stylesheet" crossorigin="anonymous">
    <link href="../css/bootstrap-multiselect.css" rel="stylesheet" crossorigin="anonymous">
</head>

<body>
<script src="../js/jquery_3.2.1.min.js" crossorigin="anonymous"></script>
<script src="../js/jquery.cookie_1.4.1.js" crossorigin="anonymous"></script>
<script src="../js/popper_1.12.9.min.js" crossorigin="anonymous"></script>
<script src="../js/bootstrap_4.0.0.min.js" crossorigin="anonymous"></script>
<script src="../js/nanobar_0.4.2.min.js" crossorigin="anonymous"></script>
<script src="../js/bootstrap-multiselect.js" crossorigin="anonymous"></script>

<div class="container col-xs-12 col-sm-12 col-md-12 col-lg-12 offset-xs-0 offset-sm-0 offset-md-0 offset-lg-0">
    <div class="row">
        <a href="#" class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
            DEV_MODE<br/>
            <img style="object-fit: contain; height:75px" src="../img/logo.png"
                 class="img-responsive img-fluid ml-2 mr-2">
        </a>
        <div class="col-xs-7 col-sm-7 col-md-7 col-lg-5 mt-2">
            <br/>
            <div class="input-group">
                <input autocomplete="off" type="text" class="form-control" placeholder="entity" id="entity"
                       value="Tesla">
                <input autocomplete="off" type="text" class="form-control" placeholder="context (optional)" id="context"
                       value="">
                <button style="height: 40px" type="button" class="btn btn-primary" id="search">Browse</button>
            </div>
            <br/>
        </div>
    </div>
</div>

<div class="container col-xs-12 col-sm-12 col-md-12 col-lg-11 mt-2">
    <table class="table table-hover"
           style="width: auto !important; table-layout: auto !important; margin-left:auto; margin-right:auto;">
        <thead id="head" hidden>
        <tr>
            <th style="width: auto !important; border-top: 0px; border-bottom: 0px;" scope="col">#</th>
            <th style="width: auto !important; border-top: 0px; border-bottom: 0px;" scope="col">Result</th>
            <th style="border-top: 0px; border-bottom: 0px;" scope="col">
                <div class="row">
                    <div class="col-8"><span style="position:absolute;bottom:0;">Source</span></div>
                    <!--                    <div class="dropdown col-4" align="right" id="sort-dropdown" hidden>-->
                    <!--                        <button class="btn dropdown-toggle btn-sm" type="button" id="sort-dropdown-btn"-->
                    <!--                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"-->
                    <!--                                style="background-color: #dff0d8; border-color: #d6e9c6; color: #3c763d">-->
                    <!--                            <strong id="sort-by-text">Sort by: Default</strong>-->
                    <!--                        </button>-->
                    <!--                        <div class="dropdown-menu" aria-labelledby="sort-dropdown-btn">-->
                    <!--                            <a class="dropdown-item dropdown-item-checked sort-option" href='#' id="sort-default">Default</a>-->
                    <!--                            <a class="dropdown-item sort-option" href='#' id="sort-quantity">Quantity</a>-->
                    <!--                            <a class="dropdown-item sort-option" href='#' id="sort-entity" hidden>Entity</a>-->
                    <!--                        </div>-->
                    <!--                    </div>-->
                </div>
            </th>
        </tr>
        </thead>
        <tbody id="data">
        </tbody>
    </table>
</div>
<br/>
<br/>
<br/>
<footer class="footer fixed-bottom" style="background-color: #ffffff; padding-top: 5px">
    <table align="center">
        <tr>
            <td valign="middle" style="padding-top: 15px">
                <div class="container mb-3">
                    &copy; 2020
                    <a href="https://www.mpi-inf.mpg.de/departments/databases-and-information-systems/"
                       referrerpolicy="no-referrer">Database
                        & Information Systems Group</a>, Max Planck Institute for Informatics
                    &nbsp;|&nbsp;<a href="https://imprint.mpi-klsb.mpg.de/inf/qsearch.mpi-inf.mpg.de"
                                    referrerpolicy="no-referrer">
                    Impressum</a>&nbsp;|&nbsp;<a
                        href="https://data-protection.mpi-klsb.mpg.de/inf/qsearch.mpi-inf.mpg.de"
                        referrerpolicy="no-referrer">
                    Datenschutzhinweis</a>
                </div>
            </td>
            <td style="width: 50px"></td>
            <td>
                <img style="height: 60px" src="../img/mpi.png" class="img-fluid" alt="logo">
            </td>
        </tr>
    </table>
</footer>
<img id="loading" src="../img/loading.gif" style="position:absolute; top:0; left:0; right:0; bottom:0; margin:auto;" hidden/>
<script src="../js/local.js" crossorigin="anonymous"></script>
<style>
    .result-img {
        max-height: 150px;
        height: auto;
        width: auto;
    }
</style>
<script>
    var nanobar = new Nanobar();
    document.getElementById('nanobarcss').innerHTML += '.nanobar .bar { background: #6aa94e; }';

    function escapeText(text) {
        return $('<div>').text(text).html();
    }

    function entityCell(inst) {
        var value = "<" + inst[0].entity.substring(5) + ">";
        value = '<a data-animation="true" data-placement="auto" data-trigger="hover" data-html="true" class="result mr-1" href="https://www.wikipedia.org/wiki/'
            + encodeURI(value.substring(1, value.length - 1)) + '" target="_blank" referrerpolicy="no-referrer">'
            + escapeText(value.substring(1, value.length - 1)).replace(/_/g, '&nbsp;')
            + '</a>';

        return $("<td style='width: auto !important;'>" + value + "</td>");
    }

    function source(value) {
        if (value.startsWith("WIKIPEDIA:Link:")) {
            value = '&rarr; <a href="' + value.substr(15) + '" target="_blank" referrerpolicy="no-referrer" class="badge badge-pill badge-danger">Wikipedia</a>';
        } else if (value.startsWith("TABLEM:Link:")) {
            value = '&rarr; <a href="' + value.substr(12) + '" target="_blank" referrerpolicy="no-referrer" class="badge badge-pill badge-success">TableL</a>';
        }
        return value;
    }

    function drawCollapsedTable(index, si) {
        var cell = $('<div>');

        var table = si.tableIndex.table;

        var preTables = $('<div class="container-fluid"><div class="row"><div class="col-auto p-0" style="max-width: 40%"></div><div class="col p-0"></div><div class="col-1 p-0 text-right"></div></div></div>');

        // titles
        var title = $('<div>');
        var titleText = escapeText(si.tableIndex.pageTitle);
        title.html('<span class="badge badge-pill badge-warning">Title</span> <span class="font-weight-bold small">'
            + titleText + '</span>');
        preTables.eq(0).children().eq(0).children().eq(0).append(title);

        // subTitles
        var st = si.tableIndex.sectionTitles.split('\r\n');
        if (st.length > 1 || st[0] != "") {
            for (var i = 0; i < st.length; ++i) {
                var subTitles = $('<div>');
                var content = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
                for (var j = 0; j < i; ++j) {
                    content += '&nbsp;&nbsp;&nbsp;&nbsp;';
                }
                var subTitleText = escapeText(st[i]);
                content += '&rdsh; <span class="small">' + subTitleText + '</span>';
                subTitles.html(content);
                preTables.eq(0).children().eq(0).children().eq(0).append(subTitles);
            }
        }

        // pageContent
        var pg = $('<div class="small ml-3 mr-1">');
        if (si.tableIndex.pageContent != "") {
            pg.html('<span class="badge badge-pill badge-info">Related Text</span> ');
            var lim = 400;
            if (si.tableIndex.pageContent.length < lim) {
                pg.append($('<span>').text(si.tableIndex.pageContent));
            } else {
                pg.append($('<span>').text(si.tableIndex.pageContent.substring(0, lim)));
                pg.append($('<span hidden>').text(si.tableIndex.pageContent.substring(lim)));
                pg.append($('<button class="btn btn-sm btn-link" onclick="showMoreText(this)">...more</button>'));
            }
        } else {
            pg.html('<span class="badge badge-pill badge-secondary">No Related Text</span>');
        }
        escapeText(si.tableIndex.pageContent);
        preTables.eq(0).children().eq(0).children().eq(1).append(pg);
        // source
        preTables.eq(0).children().eq(0).children().eq(2).html(source(si.tableIndex.table.source));

        cell.append(preTables);
        // table
        var thead = $('<thead>');
        for (var i = 0; i < table.header.length; ++i) {
            var headRow = $('<tr>');
            for (var j = 0; j < table.header[i].length; ++j) {
                if (i > 0 && table.header[i][j].text == table.header[i - 1][j].text) {
                    continue;
                }
                var c = $('<th>');
                // colspan
                var temp_1 = j;
                while (temp_1 < table.header[i].length - 1 && table.header[i][temp_1 + 1].text == table.header[i][temp_1].text) {
                    ++temp_1;
                }
                if (temp_1 > j) {
                    c.attr('colspan', temp_1 - j + 1);
                }
                // rowspan
                var temp_2 = i;
                while (temp_2 < table.header.length - 1 && table.header[temp_2 + 1][j].text == table.header[temp_2][j].text) {
                    ++temp_2;
                }
                if (temp_2 > i) {
                    c.attr('rowspan', temp_2 - i + 1);
                }

                var text = escapeText(table.header[i][j].text);
                if (si.headerUnitSpan != null && table.header[i][j].text == table.header[table.header.length - 1][si.qCol].text
                    && si.qCol >= j && si.qCol <= temp_1 && temp_2 == table.header.length - 1) {
                    var unitSpan = escapeText(si.headerUnitSpan);
                    text += '</br><span class="badge badge-pill badge-secondary">Unit/Multiplier: ' + unitSpan + '</span>';
                }
                c.html(text);
                headRow.append(c);
                j = temp_1;
            }
            thead.append(headRow);
        }
        var tbody = $('<tbody>');

        for (var i = si.row; i <= si.row; ++i) {
            var bodyRow = $('<tr>');
            for (var j = 0; j < table.data[i].length; ++j) {
                var c = $('<td>');
                var text = escapeText(table.data[i][j].text);
                if (j == si.eCol) {
                    var entitySpan = escapeText(si.entitySpan);
                    text = text.replace(entitySpan, '<span class="entity-box">' + entitySpan + '</span>');
                } else if (j == si.qCol) {
                    var quantitySpan = escapeText(si.quantitySpan);
                    text = text.replace(quantitySpan, '<span class="quantity-box ' + (index == 0 ? 'converted-quantity' : 'converted-quantity-2') + '"' +
                        ' data-animation="true" data-placement="top" data-trigger="hover" data-html="true"' +
                        ' data-content="Equals: ' +
                        (si.quantityConvertedStr == null ? "null" : si.quantityConvertedStr) +
                        '">' + quantitySpan + '</span>');
                }
                c.html(text);
                bodyRow.append(c);
            }
            tbody.append(bodyRow);
        }

        var t = $('<table>');
        t.append(thead, tbody);
        t.attr("class", "table table-sm w-auto small table-bordered mb-0");

        cell.append(t);

        // caption
        var wrapper = $('<div style="text-align: center;"><div style="display: inline-block;"></div></div>');
        if (si.tableIndex.caption != "") {
            var captionText = escapeText(si.tableIndex.caption);
            wrapper.eq(0).children().eq(0).html('<span class="badge badge-pill badge-success">Caption</span> <span class="font-weight-bold small">' + captionText + '</span>');
        } else {
            wrapper.eq(0).children().eq(0).html('<span class="badge badge-pill badge-secondary">No Caption</span>');
        }
        cell.append(wrapper);
        return cell;
    }

    var wikiLinkToImageMap = {};

    function showMoreText(current) {
        if ($(current).text() == "...more") {
            $(current).text("...less");
            $(current).prev().removeAttr('hidden');
        } else {
            $(current).text("...more");
            $(current).prev().attr('hidden', 'hidden');
        }
    }

    function encodeEntityResultAsHtml(index, instance) {
        var line = "<tr style='border-top:2px solid gray'>";
        line += "<td style='width: auto !important;'>" + (index + 1) + "</td>";
        var eCel = entityCell(instance);
        line += eCel.wrapAll('<div>').parent().html();

        var tCel = $('<td>');
        tCel.append(drawCollapsedTable(0, instance[0]));

        if (instance.length > 1) {
            // var wrapper = $('<div style="text-align: center;"><div style="display: inline-block;"></div></div>');
            // wrapper.eq(0).children().eq(0).html('<button class="mt-1 btn btn-link" onclick="showMoreTables(' + index + ', this)">Show more</button>');
            // tCel.append(wrapper);
            // var moreTCel = $('<div class="collapse">');
            for (var i = 1; i < instance.length; ++i) {
                tCel.append($('<hr>'));
                tCel.append(drawCollapsedTable(i, instance[i]));
            }
            // tCel.append(moreTCel);
        }

        line += tCel.wrapAll('<div>').parent().html();

        line += "</tr>";
        return line;
    }

    function show(data) {
        var topResults = data.result;
        if (topResults.length == 0) {
            $("#data").html("<br/><br/>NO DATA");
        } else {
            $("#head").removeAttr("hidden");
            var str = "";
            for (var i = 0; i < topResults.length; ++i) {
                var instance = topResults[i];
                // populate tableIndex
                for (var j = 0; j < instance.length; ++j) {
                    instance[j].tableIndex = data.tableId2Index[instance[j].tableId];
                }

                $("#data").append();
                str += encodeEntityResultAsHtml(i, instance);
            }
            $("#data").html(str);
        }

        $('.result').each(function () {
            var current = this;
            if ($(current).attr('href') in wikiLinkToImageMap) {
                if (wikiLinkToImageMap[$(current).attr('href')] != 'None') {
                    // $(current).attr("data-content", wikiLinkToImageMap[$(current).attr('href')]);
                    $(current).parent().append($('</br>' + wikiLinkToImageMap[$(current).attr('href')]).addClass('mt-1 rounded result-img'));
                    $(current).popover();
                    if ($(current).is(':hover')) {
                        $(current).trigger('mouseenter');
                    }
                }
            } else {
                $.ajax({
                    type: "GET",
                    url: "/wikilink",
                    data: {"link": $(current).attr("href")},
                    contentType: 'application/json; charset=utf-8',
                    dataType: "json",
                    success: function (data) {
                        if ("imgLink" in data) {
                            var imgLink = "<img referrerpolicy=\"no-referrer\" style=\"object-fit: contain;\" src=\"" + data["imgLink"] + "\" class=\"img-responsive img-fluid\">";
                            // $(current).attr("data-content", imgLink);
                            $(current).parent().append($('</br>' + imgLink).addClass('mt-1 rounded result-img'));
                            wikiLinkToImageMap[$(current).attr("href")] = imgLink;
                            $(current).popover();
                            if ($(current).is(':hover')) {
                                $(current).trigger('mouseenter');
                            }
                        } else {
                            wikiLinkToImageMap[$(current).attr("href")] = "None";
                        }
                    }
                });
            }
        });
    }

    function search() {
        var params = {
            entity: $("#entity").val(),
            context: $("#context").val()
        };

        $("#search").attr('disabled', 'disabled').html("Browsing <i class=\"fas fa-spinner fa-spin\"></i>");
        $("#entity").attr('disabled', 'disabled');
        $("#context").attr('disabled', 'disabled');

        $.ajax({
            type: "GET",
            url: "/browse_table",
            data: params,
            contentType: 'application/json; charset=utf-8',
            dataType: "json",
            success: function (data) {
                window.location.replace("/table/experimental/browser.html?s=" + data.s + "&q=" + encodeURIComponent(btoa(encodeURIComponent(JSON.stringify(params)))));
            },
            error: function () {
                alert("An error occurred.");
            },
            complete: function () {
                $("#search").removeAttr('disabled').html("Browse");
                $("#entity").removeAttr('disabled');
                $("#context").removeAttr('disabled');
            }
        });
    }

    $("#search").click(search);
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("q")) {
        var q = JSON.parse(decodeURIComponent(atob(decodeURIComponent(urlParams.get("q")))));
        $("#entity").val(q.entity);
        $("#context").val(q.context);
    }
    var data = null;
    if (urlParams.has("s")) {
        $.ajax({
            type: "GET",
            url: "/session",
            data: {"s": urlParams.get('s')},
            contentType: 'application/json; charset=utf-8',
            dataType: "json",
            beforeSend: function () {
                $("#search").attr('disabled', 'disabled');
                $("#entity").attr('disabled', 'disabled');
                $("#context").attr('disabled', 'disabled');
                $("#loading").removeAttr('hidden');
            },
            success: function (response) {
                data = response;
                show(data);
            },
            error: function () {
                alert("Invalid session.");
            },
            complete: function () {
                $("#search").removeAttr('disabled');
                $("#entity").removeAttr('disabled');
                $("#context").removeAttr('disabled');
                $("#loading").attr('hidden', 'hidden');
            }
        });
    }

    $('#entity').on("keydown", function (e) {
        if (e.keyCode == 13) {
            $("#search").click();
        }
    });
</script>
</body>
</html>
