<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Qfact Explorer</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
          integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

</head>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<div id="template-check-form" hidden>
    <label class="radio-inline text-success font-weight-bold">
        <input type="radio" name="verdict-template" value="true">True
    </label>
    <label class="radio-inline text-danger font-weight-bold">
        <input type="radio" name="verdict-template" value="false">False
    </label>
</div>

<body>
DEV_MODE
<div class="container">
    <div class="row">
<!--        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">-->
<!--            &lt;!&ndash; TODO: build saving component &ndash;&gt;-->
<!--            <select hidden class="browser-default custom-select" id="eval-domain">-->
<!--                <option disabled selected>Evaluation domain</option>-->
<!--                <option value="FINANCE">FINANCE</option>-->
<!--                <option value="SPORTS">SPORTS</option>-->
<!--                <option value="TRANSPORT">TRANSPORT</option>-->
<!--                <option value="GEOMIS">GEO & MISCELLANEOUS</option>-->
<!--                <option value="TECHNOLOGY">TECHNOLOGY</option>-->
<!--            </select>-->
<!--        </div>-->
<!--        <div hidden class="col-xs-2 col-sm-2 col-md-2 col-lg-2">-->
<!--            <select class="browser-default custom-select" id="model">-->
<!--                <option disabled>Ranking model</option>-->
<!--                <option value selected="EMBEDDING">EMBEDDING</option>-->
<!--                <option value="KL">KULLBACK_LEIBLER</option>-->
<!--            </select>-->
<!--        </div>-->
        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
<!--            <i class="glyphicon glyphicon-refresh"></i>-->
            <div class="input-group">
                <button id="change-mode" hidden class="btn"><i class="fas fa-sync-alt"></i></button>
                <input type="text" class="form-control" placeholder="type" id="type"
                       value="businessperson">
                <input type="text" class="form-control" placeholder="context" id="context"
                       value="net worth">
<!--                <input hidden type="text" class="form-control" placeholder="quantity constraint" id="quantity"-->
<!--                       value="more than 50 km">-->
<!--                <input hidden type="text" class="form-control" placeholder="what do you want to search for?" id="full"-->
<!--                       value="electric cars with range more than 50 km">-->
                <span class="input-group-btn"><input class="btn btn-success" type="submit" value="Explore"
                                                     id="search"></span>
                <div id="mode-full" value=1></div>
            </div>
        </div>
    </div>
</div>
<br/>
<div class="container col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div id="parsed"></div>
</div>
<div class="container col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <table class="table table-sm">
        <thead>
        <tr>
            <th scope="col">#</th>
            <!--            <th scope="col">Score</th>-->
            <th scope="col">Entity</th>
            <!--<th scope="col">Quantity</th>-->
            <th scope="col">Context</th>
            <th scope="col">Quantity</th>
            <th scope="col">Domain</th>
            <th scope="col">Source</th>
            <!--            <th scope="col">Verdict</th>-->
        </tr>
        </thead>
        <tbody id="data">
        </tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <!--<td></td>-->
            <td></td>
            <!--            <td id="submit-status"></td>-->
            <!--            <td><input hidden class="btn btn-normal" type="submit" value="Submit" id="submit"></td>-->
        </tr>
    </table>
</div>

<script>
    var global_data = null;

    function createCheckForm(id) {
        var data = $("#template-check-form").html();
        data = data.split("verdict-template").join("verdict-" + String(id));
        return data;
    }

    $("#change-mode").click(function () {
        var currentMode = $("#mode-full").attr("value");
        if (currentMode == 0) {
            $("#type").attr("hidden", "");
            $("#context").attr("hidden", "");
            $("#quantity").attr("hidden", "");
            $("#full").removeAttr("hidden");
        } else {
            $("#type").removeAttr("hidden");
            $("#context").removeAttr("hidden");
            $("#quantity").removeAttr("hidden");
            $("#full").attr("hidden", "");
        }
        $("#mode-full").attr("value", 1 - currentMode);
    });

    function escapeText(text) {
        return $('<div>').text(text).html();
    }

    function cell(value, rowspan) {
        value = String(value);
        if (value.startsWith("<")) {
            var eText = value.substring(1, value.length - 1).replace(/_/g, ' ');
            value = '<a href="https://wikipedia.org/wiki/'
                + escape(value.substring(1, value.length - 1)) + '" target="_blank">'
                + escapeText(eText)
                + '</a>';
        } else if (value.startsWith("WIKIPEDIA:Link:")) {
            var link = value.substr(15);
            value = '<span class="wiki-box">Wiki</span> <a href="' + value.substr(15) + '" target="_blank">' + link + '</a>';
        } else if (value.startsWith("TABLEM:Link:")) {
            var link = value.substr(12);
            value = '<span class="tablel-box">TableL</span> <a href="' + value.substr(12) + '" target="_blank">' + link + '</a>';
        } else {
            value = escapeText(value);
        }
        return "<td rowspan='" + rowspan + "'>" + value + "</td>";
    }

    function encode(index, inst) {
        var subI = inst["subInstances"];
        var line = "";
        for (var i = 0; i < subI.length; ++i) {
            line += "<tr>";
            if (i == 0) {
                line += cell(index, subI.length);
                line += cell(inst["entity"], subI.length);
            }
            line += cell(subI[i]["context"].replace(/","/g, '" , "'), 1);
            line += cell(subI[i]["quantity"], 1);
            line += cell(subI[i]["domain"], 1);
            line += cell(subI[i]["source"], 1);

            // line += "<td>" + (verdictId == null ? "" : createCheckForm(verdictId)) + "</td>";
            line += "</tr>";
        }
        return line;
    }

    function search() {
        // if ($("#model").val() == null) {
        //     alert("Please choose ranking model.");
        //     return;
        // }
        // var params;
        // if ($("#mode-full").attr("value") == 1) {
        //     params = {full: $("#full").val()};
        // } else {
        params = {type: $("#type").val(), context: $("#context").val(), quantity: $("#quantity").val()};
        // }
        // params["model"] = $("#model").val();

        $.ajax({
            type: "GET",
            url: "/search/",
            data: params,
            contentType: 'application/json; charset=utf-8',
            dataType: "json",
            beforeSend: function () {
                $("#search").attr('disabled', 'disabled').attr("value", "Wait...");
                // $("#parsed").html("");
                $("#data").html("");
                $("#submit").attr("hidden", "");
                // $("#submit-status").html("");
                global_data = null;
            },
            success: function (data) {
                global_data = data;
                // if (data["verdict"] != "OK") {
                //     $("#parsed").html("");
                //     $("#data").html(data["verdict"]);
                //     return;
                // }
                // var topResults = data["topResults"];
                // var parsed = {
                //     "Type": data["typeConstraint"],
                //     "Context": data["contextConstraint"],
                //     "Quantity": data["quantityConstraint"],
                //     "Model": data["matchingModel"]
                // };
                // $("#parsed").html(JSON.stringify(parsed));
                // $("#type").val(parsed["Type"]);
                // $("#context").val(parsed["Context"]);
                // $("#quantity").val(parsed["Quantity"]["phrase"]);
                if (data.length == 0) {
                    $("#data").html("NO DATA");
                } else {
                    var str = "";
                    for (var i = 0; i < data.length; ++i) {
                        str += encode(i, data[i]);
                    }
                    $("#data").html(str);
                    $("#submit").removeAttr("hidden");
                }
            },
            error: function () {
                alert("An error occurred.");
            },
            complete: function () {
                $("#search").removeAttr('disabled').attr("value", "Explore");;
            }
        });
    }

    // function submit() {
    //     if (global_data == null) {
    //         alert("An error occured.");
    //         return;
    //     }
    //     if ($("#eval-domain").val() == null) {
    //         alert("Please choose evaluation domain.");
    //         return;
    //     }
    //     for (var i = 0; i < global_data["topResults"].length; ++i) {
    //         var verdict = $("input[name=verdict-" + String(i) + "]:checked").val();
    //         if (verdict == null) {
    //             alert("Please evaluate all the results.");
    //             return;
    //         }
    //         global_data["topResults"][i]["eval"] = verdict;
    //     }
    //     global_data["evalDomain"] = $("#eval-domain").val();
    //
    //     $.ajax({
    //         type: "POST",
    //         url: "/evaluate/",
    //         data: JSON.stringify(global_data),
    //         contentType: 'application/json; charset=utf-8',
    //         dataType: "json",
    //         beforeSend: function () {
    //             $("#submit").attr('disabled', 'disabled').attr("value", "Submitting");
    //             $("#search").attr('disabled', 'disabled');
    //         },
    //         success: function (data) {
    //             if (data["verdict"] == "OK") {
    //                 $("#submit-status").html('<p class="text-success font-weight-bold">SAVED</p>');
    //             } else if (data["verdict"] == "OVERWRITE") {
    //                 $("#submit-status").html('<p class="text-warning font-weight-bold">OVERWRITTEN</p>');
    //             } else {
    //                 $("#submit-status").html('<p class="text-danger font-weight-bold">ERROR</p>');
    //             }
    //         },
    //         error: function () {
    //             alert("An error occurred.");
    //         },
    //         complete: function () {
    //             $("#submit").removeAttr('disabled').attr("value", "Submit");
    //             $("#search").removeAttr('disabled');
    //         }
    //     });
    // }

    $("#search").click(search);

    // $("#submit").click(submit);

    // $("#change-mode").click();
</script>
<style>
    .wiki-box {
        border-radius: 5px;
        background: #e6ffcc;
        border: 1px solid #66BB6A;
        padding: 2px;
    }



    .tablel-box {
        border-radius: 5px;
        background: #FADBD8;
        border: 1px solid #EF5350;
        padding: 2px;
    }
</style>
<script>
    // Type suggestion
    function showSuggestedType(input, listDOM, prefix, suggestedType) {
        // for each item in the array...
        for (i = 0; i < suggestedType.length; i++) {
            //check if the item starts with the same letters as the text field value:
            if (suggestedType[i]['first'].substr(0, prefix.length) == prefix) {
                // create a DIV element for each matching element:
                var b = document.createElement("DIV");
                // make the matching letters bold:*/
                b.innerHTML = "<strong>" + suggestedType[i]['first'].substr(0, prefix.length) + "</strong>";
                b.innerHTML += suggestedType[i]['first'].substr(prefix.length);
                b.innerHTML += ' (' + suggestedType[i]['second'] + ')';
                // insert a input field that will hold the current array item's value:
                b.innerHTML += "<input type='hidden' value='" + suggestedType[i]['first'] + "'>";
                // execute a function when someone clicks on the item value (DIV element):
                b.addEventListener("click", function (e) {
                    // insert the value for the autocomplete text field:
                    input.value = this.getElementsByTagName("input")[0].value;
                    // close the list of autocompleted values,
                    //(or any other open lists of autocompleted values:
                    closeAllLists();
                });
                listDOM.appendChild(b);
            }
        }
    }

    var isFetching = false;
    var currentFocus = -1;

    function autocomplete(inp) {
        // the autocomplete function takes two arguments,
        // the text field element and an array of possible autocompleted values:

        // execute a function when someone writes in the text field:
        inp.addEventListener("input", function (e) {
            if (isFetching) {
                return;
            }
            var val = this.value;
            // close any already open lists of autocompleted values
            closeAllLists();
            if (!val) {
                return false;
            }
            currentFocus = -1;
            //create a DIV element that will contain the items (values):
            var listDOM = document.createElement("DIV");
            listDOM.setAttribute("id", this.id + "-autocomplete-list");
            listDOM.setAttribute("class", "autocomplete-items");
            listDOM.style.width = $('#full').css('width');
            //append the DIV element as a child of the autocomplete container:
            this.parentNode.appendChild(listDOM);

            // get suggestion types from API
            var params = {prefix: val};
            $.ajax({
                type: "GET",
                url: "/type_suggest/",
                data: params,
                contentType: 'application/json; charset=utf-8',
                dataType: "json",
                beforeSend: function () {
                    isFetching = true;
                },
                success: function (data) {
                    showSuggestedType(inp, listDOM, data['prefix'], data['suggestions']);
                },
                error: function () {
                    // do nothing.
                },
                complete: function () {
                    isFetching = false;
                }
            });
        });

        function closeAllLists(elmnt) {
            // close all autocomplete lists in the document, except the one passed as an argument:
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
            currentFocus = -1;
        }

        // execute a function presses a key on the keyboard:
        inp.addEventListener("keydown", function (e) {
            var x = document.getElementById(this.id + "-autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                // If the arrow DOWN key is pressed, increase the currentFocus variable:
                currentFocus++;
                // and and make the current item more visible:
                addActive(x);
            } else if (e.keyCode == 38) {
                // If the arrow UP key is pressed, decrease the currentFocus variable:
                currentFocus--;
                // and and make the current item more visible:
                addActive(x);
            } else if (e.keyCode == 13) {
                // If the ENTER key is pressed, prevent the form from being submitted,
                e.preventDefault();
                if (currentFocus > -1) {
                    // and simulate a click on the "active" item:
                    if (x) x[currentFocus].click();
                    currentFocus = -1;
                } else {
                    $("#search").click();
                }
            } else if (e.keyCode == 27) {
                // If the ESC key is pressed
                currentFocus = -1;
                closeAllLists();
            }
        });

        function addActive(x) {
            // a function to classify an item as "active":
            if (!x) return false;
            // start by removing the "active" class on all items:
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            // add class "autocomplete-active":
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            // a function to remove the "active" class from all autocomplete items:
            for (var i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        // execute a function when someone clicks in the document:
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });

    }

    autocomplete(document.getElementById("type"));
</script>
<style>
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
    }

    .autocomplete-items div {
        padding: 5px;
        cursor: pointer;
        background-color: #ffffff;
        border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
        /* when hovering an item: */
        background-color: #e9e9e9;
    }

    .autocomplete-active {
        /*when navigating through the items using the arrow keys:*/
        background-color: DodgerBlue !important;
        color: #ffffff;
    }
</style>
</body>
</html>